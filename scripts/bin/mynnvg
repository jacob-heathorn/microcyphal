#!/bin/bash

set -e

pushd $PROJECT_ROOT/scripts/package

DSDL_PATH=~/.cyphal/uavcan
OUT_PATH_CPP=$PROJECT_ROOT/.bin/generated/cpp17

echo "DSDL_PATH: $DSDL_PATH"
echo "OUT_PATH_CPP: $OUT_PATH_CPP"

# Create output directory if it doesn't exist
mkdir -p "$OUT_PATH_CPP"

# Generate C++ version for entire uavcan namespace
echo "Generating C++ version for entire uavcan namespace..."
poetry run nnvg \
    --target-language cpp \
    --language-standard c++17 \
    --include-experimental-languages \
    --outdir "$OUT_PATH_CPP" \
    --lookup-dir "$DSDL_PATH" \
    --jobs 16 \
    --verbose \
    "$DSDL_PATH"

echo "Generated C++ files (showing first 20):"
find "$OUT_PATH_CPP" -name "*.hpp" | head -20
echo "Total generated files:"
find "$OUT_PATH_CPP" -name "*.hpp" | wc -l
